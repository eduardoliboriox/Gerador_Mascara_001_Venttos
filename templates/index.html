<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerador de M√°scara - Venttos MES</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background-color: white; padding: 20px; max-width: 800px; margin: auto; }
        label { font-weight: bold; }
        select, input[type="text"], textarea { width: 100%; max-width: 400px; padding: 10px; margin: 5px 0 15px 0; box-sizing: border-box; }
        button { background-color: #32406b; color: white; border: none; padding: 10px 20px; margin: 5px 5px 5px 0; cursor: pointer; border-radius: 4px; font-size: 1em; }
        button:hover { background-color: #47527f; }
        .resultado { background-color: #f2f2f2; padding: 15px; margin-top: 20px; width: 100%; max-width: 600px; white-space: pre-wrap; box-sizing: border-box; border-radius: 4px; }
        .exemplo { font-size: 0.9em; color: #444; margin: -10px 0 15px 0; }
        @media (max-width: 600px) { body { padding: 15px; } select, input[type="text"], textarea, button { max-width: 100%; font-size: 1em; } }
    </style>
</head>
<body>
    <h2>GERADOR DE M√ÅSCARA - VENTTOS M.E.S</h2>

    <form id="formulario">
        <label>Cliente:</label><br>
        <select name="cliente" id="cliente" required onchange="atualizarModelos()">
            {% for cliente in clientes %}
                <option value="{{ cliente }}">{{ cliente }}</option>
            {% endfor %}
        </select><br>

        <label>Modelo:</label><br>
        <select name="modelo" id="select_modelo"></select>
        <input type="text" name="modelo" id="input_modelo" style="display:none;" placeholder="Digite o modelo"><br>
        <button type="button" onclick="adicionarModelo()">Adicionar Modelo</button>

        <!-- Campo para c√≥digo completo ELGIN -->
        <div id="div_codigo_elgin" style="display:none;">
            <label>C√≥digo completo ELGIN - Escaneie uma etiqueta no processo:</label><br>
            <input type="text" name="codigo_elgin" id="codigo_elgin" placeholder="ARC2437004417500EBRHRC07052"><br>
        </div>

        <div class="exemplo" id="exemploMascara" style="display:none;"></div>

        <label>OP (5 letras + 6 n√∫meros):</label><br>
        <input type="text" name="op" id="op" required maxlength="11"
               style="text-transform: uppercase;"
               oninput="this.value = this.value.toUpperCase();"><br>

        <label>J√° existe uma m√°scara?</label><br>
        <input type="radio" name="tem_mascara" value="sim" onclick="mostrarCampoMascara(true)"> Sim
        <input type="radio" name="tem_mascara" value="nao" checked onclick="mostrarCampoMascara(false)"> N√£o<br>

        <div id="div_mascara" style="display:none;">
            <label>Digite a m√°scara atual:</label><br>
            <input type="text" name="mascara_atual"><br>
        </div>

        <button type="submit">Gerar M√°scara</button>
        <button type="button" onclick="limparCampos()">Limpar Campos</button>
        <button type="button" onclick="copiarMascara()">Copiar M√°scara</button>
    </form>

    <div class="resultado" id="resultado"></div>

    <script>
        const modelosData = {{ modelos | tojson | safe }};
        const selectModelo = document.getElementById("select_modelo");
        const inputModelo = document.getElementById("input_modelo");
        const divCodigoElgin = document.getElementById("div_codigo_elgin");
        const exemploMascara = document.getElementById("exemploMascara");

        function atualizarModelos() {
            const cliente = document.getElementById("cliente").value;
            const lista = modelosData[cliente];

            if (lista && lista.length > 0) {
                selectModelo.innerHTML = "";
                lista.forEach(m => {
                    const opt = document.createElement("option");
                    opt.value = m;
                    opt.text = m;
                    selectModelo.appendChild(opt);
                });
                selectModelo.style.display = "inline";
                inputModelo.style.display = "none";
            } else {
                selectModelo.style.display = "none";
                inputModelo.style.display = "inline";
                inputModelo.value = "";
            }

            // Removemos todos os textos de exemplo
            divCodigoElgin.style.display = (cliente === "ELGIN") ? "block" : "none";
            exemploMascara.style.display = "none";
        }

        function mostrarCampoMascara(exibir) {
            document.getElementById("div_mascara").style.display = exibir ? "block" : "none";
        }

        function limparCampos() {
            document.getElementById("formulario").reset();
            atualizarModelos();
            mostrarCampoMascara(false);
            document.getElementById("resultado").innerText = "";
        }

        function copiarMascara() {
            const resultado = document.getElementById("resultado").innerText;

            if (!resultado.includes("M√ÅSCARA CORRETA")) {
                alert("‚ùå Nenhuma m√°scara gerada para copiar.");
                return;
            }

            const linhas = resultado.split("\n");
            const indice = linhas.indexOf("‚úÖ M√ÅSCARA CORRETA:");
            const mascara = indice !== -1 ? linhas[indice + 1] : "";

            if (!mascara) {
                alert("‚ùå N√£o foi poss√≠vel identificar a m√°scara.");
                return;
            }

            navigator.clipboard.writeText(mascara).then(() => {
                alert("‚úÖ M√°scara copiada para a √°rea de transfer√™ncia!");
            }).catch(() => {
                alert("‚ùå Erro ao copiar.");
            });
        }

        // Fun√ß√£o para adicionar modelo dinamicamente
        function adicionarModelo() {
            const cliente = document.getElementById("cliente").value;
            const novoModelo = prompt("Digite o novo modelo para o cliente " + cliente + ":");

            if (novoModelo && novoModelo.trim() !== "") {
                if (!modelosData[cliente]) {
                    modelosData[cliente] = [];
                }
                modelosData[cliente].push(novoModelo.trim());
                atualizarModelos();
                selectModelo.value = novoModelo.trim();
                alert("‚úÖ Modelo adicionado ao cliente " + cliente + "!");
            } else {
                alert("‚ùå Modelo inv√°lido.");
            }
        }

        document.getElementById("formulario").onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            if (selectModelo.style.display === "none") {
                formData.set("modelo", inputModelo.value);
            } else {
                formData.set("modelo", selectModelo.value);
            }

            const res = await fetch("/gerar", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            let out = "";

            if (data.erro) {
                out = data.erro;
            } else {
                out += data.validacao_op + "\n\n";
                out += "‚úÖ M√ÅSCARA CORRETA:\n" + data.mascara + "\n";

                if (data.comparacao) {
                    out += "\nüîç Comparando com a m√°scara digitada:\n";
                    data.comparacao.forEach(erro => {
                        out += erro + "\n";
                    });
                }
            }

            document.getElementById("resultado").innerText = out;
        }

        window.onload = atualizarModelos;
    </script>
</body>
</html>
